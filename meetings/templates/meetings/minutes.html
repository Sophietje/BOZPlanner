{% extends "base-minutes.html" %}

<!-------------some sort of permissions can be build in, the BOZ and OLC should see this page------>
{% block content %}
    <h1>Minutes</h1>
    <hr>
    <div class="table">
       <table class="table table-hover data-table" data-order='[[1, "desc"]]'>
            <thead>
                <tr>
                    <th>Subject</th>
                    <th>Date & Time</th>
                    <th>Location</th>
                    <th>Secretary</th>
                    <th class="btn-cell no-sort">Upload&nbsp;-&nbsp;Options</th>
                </tr>
            </thead>
            <tbody>
                <!------------------table filled in, there is not much more for this block--------->
                {% for meeting in object_list %}
                    <tr>
                        <td>{{ meeting.organization }}</td>
                        <td data-order="{{ meeting.begin_time|date:"YmdHi" }}">{{ meeting.begin_time }}</td>
                        <td>{{ meeting.place }}</td>
                        {% if meeting.secretary != None %}
                            <td>{{ meeting.secretary }}</td>
                        {% else %}
                            <td><em><small>None</small></em></td>
                        {% endif %}

                        <!------------------There should be a download button to request the meetings-------->
                        <td class="btn-cell"><div>
                            {# Upload minutes form #}
                            <form method="post" action="{% url 'meetings:minutes-upload' %}" class="upload-form" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" name="meeting" value="{{ meeting.pk }}">
                                <input type="file" name="minutes" style="display: none">
                                <!-----------When may you see the upload button?------------>
                                {%  if meeting.secretary == user or perms.meetings.add_minutes %}
                                    <button type="button" class="btn btn-default">
                                        <span class="glyphicon glyphicon-open" aria-hidden="true"></span>
                                    </button>
                                {% endif %}
                            </form>

                            &nbsp;

                            {% if meeting.minutes.all|length == 0%}
                                {# nop #}
                            {% else %}
                                <div class="btn-group">

                                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Minutes <span class="caret"></span>
                                    </button>

                                    <ul class="dropdown-menu pull-right">
                                        {% for minutes in meeting.minutes.all %}
                                            <li style="vertical-align: middle">
                                                <a onclick="window.location='{% url 'meetings:minutes-download' minutes.pk %}'" style="cursor: pointer">
                                                    {{ minutes.original_name }}
                                                    <em><small>{{ minutes.date }}</small></em>
                                                    <span class="btn btn-default btn-sm dropdown-button">
                                                        <i class="glyphicon glyphicon-save"></i>
                                                    </span>
                                                    {% if perms.meetings.delete_minutes or meeting.secretary == user %}
                                                        <span onclick="event.preventDefault(); event.stopPropagation(); event.stopImmediatePropagation(); $('#deleteModal-{{ minutes.pk }}').modal('show')" href="#" class="btn btn-danger btn-sm dropdown-button"  data-toggle="modal" data-target="deleteModal-{{ minutes.pk }}">
                                                            <i class="glyphicon glyphicon-remove"></i>
                                                        </span>
                                                    {% endif %}
                                                </a>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </div></td>
                    </tr>
                {% endfor %}
           </tbody>
       </table>
    </div>

    {% for meeting in object_list %}
        {% for minutes in meeting.minutes.all %}
            <div id="deleteModal-{{ minutes.pk }}" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="post" action="{% url 'meetings:minutes-delete' minutes.pk %}">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title">Delete minutes</h4>
                            </div>
                            <div class="modal-body">
                                {% csrf_token %}
                                Are you sure you want to remove the file {{ minutes.original_name }} uploaded at {{ minutes.date }}?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                <input class="btn btn-danger" type="submit" value="Delete">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endfor %}

    <script type="text/javascript">
        $(function() {
            $('.upload-form').each(function(_, form) {
                form = $(form);

                form.find('button').click(function() {
                    form.find('input[type=file]').click();
                });

                form.find('input[type=file]').change(function() {
                    form.submit();
                });
            });
        })
    </script>
{% endblock %}
